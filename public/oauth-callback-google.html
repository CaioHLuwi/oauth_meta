<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta http-equiv="Cross-Origin-Opener-Policy" content="same-origin-allow-popups" />
  <meta http-equiv="Cross-Origin-Embedder-Policy" content="unsafe-none" />
  <title>Google Ads OAuth Callback</title>
</head>
<body>
  <h1>Retornando do Google OAuth‚Ä¶</h1>
  <p>Esta janela ser√° fechada automaticamente.</p>

  <script>
    (async function() {
      try {
        const params = new URLSearchParams(window.location.search);
         const accessToken  = params.get('access_token');
         const refreshToken = params.get('refresh_token');
         const error        = params.get('error');
         const userDataStr  = params.get('user_data');
         
         let userData = null;
         if (userDataStr) {
           try {
             userData = JSON.parse(userDataStr);
           } catch (e) {
             console.warn('Erro ao parsear dados do usu√°rio:', e);
           }
         }

        let result;
        if (accessToken) {
           // Sucesso
           result = {
             accessToken,
             refreshToken,
             userInfo: userData?.userInfo || null,
             adsAccounts: userData?.adsAccounts || null,
             timestamp: Date.now()
           };
           
           // Preparar informa√ß√µes do usu√°rio para exibi√ß√£o
            const userInfo = userData?.userInfo;
            const adsAccounts = userData?.adsAccounts;
            
            let userDisplay = '';
            if (userInfo) {
              userDisplay = `
                <div style="margin: 20px 0; padding: 15px; background: #f0f8ff; border-radius: 8px; border-left: 4px solid #4285f4;">
                  <h3 style="margin: 0 0 10px 0; color: #1a73e8;">Conta Google Conectada:</h3>
                  ${userInfo.picture ? `<img src="${userInfo.picture}" alt="Foto do perfil" style="width: 50px; height: 50px; border-radius: 50%; margin-right: 15px; vertical-align: middle;">` : ''}
                  <div style="display: inline-block; vertical-align: middle;">
                    <p style="margin: 0; font-weight: bold; font-size: 16px;">${userInfo.name || 'Nome n√£o dispon√≠vel'}</p>
                    <p style="margin: 0; color: #666; font-size: 14px;">${userInfo.email || 'Email n√£o dispon√≠vel'}</p>
                    <p style="margin: 5px 0 0 0; color: #888; font-size: 12px;">ID: ${userInfo.id || 'N/A'}</p>
                  </div>
                </div>
              `;
            }
            
            let adsDisplay = '';
            if (adsAccounts && adsAccounts.resourceNames && adsAccounts.resourceNames.length > 0) {
              const accountCount = adsAccounts.resourceNames.length;
              adsDisplay = `
                <div style="margin: 20px 0; padding: 15px; background: #fff3cd; border-radius: 8px; border-left: 4px solid #ffc107;">
                  <h3 style="margin: 0 0 10px 0; color: #856404;">üìä Contas Google Ads Detectadas:</h3>
                  <p style="margin: 0; font-weight: bold; color: #856404;">${accountCount} conta(s) de an√∫ncios encontrada(s)</p>
                  <p style="margin: 5px 0 0 0; color: #6c757d; font-size: 12px;">Dados detalhados de campanhas, or√ßamentos e m√©tricas dispon√≠veis via API</p>
                </div>
              `;
            } else if (adsAccounts && adsAccounts.error) {
              // Erro espec√≠fico (como developer token n√£o configurado)
              adsDisplay = `
                <div style="margin: 20px 0; padding: 15px; background: #f8d7da; border-radius: 8px; border-left: 4px solid #dc3545;">
                  <h3 style="margin: 0 0 10px 0; color: #721c24;">üîß Configura√ß√£o Necess√°ria:</h3>
                  <p style="margin: 0; color: #721c24; font-weight: bold;">${adsAccounts.error}</p>
                  ${adsAccounts.message ? `<p style="margin: 5px 0 0 0; color: #721c24; font-size: 14px;">${adsAccounts.message}</p>` : ''}
                  ${adsAccounts.details ? `<details style="margin: 10px 0 0 0;"><summary style="color: #721c24; cursor: pointer;">Detalhes t√©cnicos</summary><pre style="background: #f1f1f1; padding: 10px; margin: 5px 0; font-size: 11px; overflow-x: auto;">${adsAccounts.details}</pre></details>` : ''}
                  <p style="margin: 10px 0 0 0; color: #6c757d; font-size: 12px;">Consulte o arquivo google-ads-permissions.json para instru√ß√µes detalhadas</p>
                </div>
              `;
            } else {
              adsDisplay = `
                <div style="margin: 20px 0; padding: 15px; background: #f8d7da; border-radius: 8px; border-left: 4px solid #dc3545;">
                  <h3 style="margin: 0 0 10px 0; color: #721c24;">‚ö†Ô∏è Google Ads:</h3>
                  <p style="margin: 0; color: #721c24;">Nenhuma conta do Google Ads encontrada ou acesso negado</p>
                  <p style="margin: 5px 0 0 0; color: #6c757d; font-size: 12px;">Verifique se possui contas ativas no Google Ads e se as permiss√µes est√£o corretas</p>
                </div>
              `;
            }
           
           // Atualiza a UI
           document.body.innerHTML = `
             <h1 style="color: green;">‚úÖ Autentica√ß√£o Google Conclu√≠da!</h1>
             <p>Token obtido com sucesso!</p>
             ${userDisplay}
             ${adsDisplay}
             <p style="margin-top: 20px; color: #666;">Esta janela ser√° fechada automaticamente em alguns segundos.</p>
           `;
          
          // Notifica a janela principal com try/catch
          try {
            if (window.opener && !window.opener.closed) {
              window.opener.postMessage({
                type: 'GOOGLE_AUTH_SUCCESS',
                result: result
              }, '*');
            }
          } catch (e) {
            console.log('Erro ao comunicar com janela principal:', e);
          }
        } else {
          // Erro
          const message = error || 'Access token not found in URL';
          result = {
            error: message,
            timestamp: Date.now()
          };
          
          // Atualiza a UI
          document.body.innerHTML = `
            <h1 style="color: red;">‚ùå Erro na Autentica√ß√£o Google</h1>
            <p><strong>Motivo:</strong> ${message}</p>
            <p>Esta janela ser√° fechada automaticamente.</p>
          `;
          
          // Notifica a janela principal com try/catch
          try {
            if (window.opener && !window.opener.closed) {
              window.opener.postMessage({
                type: 'GOOGLE_AUTH_ERROR',
                result: result
              }, '*');
            }
          } catch (e) {
            console.log('Erro ao comunicar com janela principal:', e);
          }
        }

        // Salva o resultado no localStorage
        localStorage.setItem('google_ads_oauth_result', JSON.stringify(result));
        localStorage.setItem('google_ads_access_token', accessToken || '');

        // Fecha a janela ap√≥s 3 segundos
        setTimeout(() => {
          try {
            window.close();
          } catch (e) {
            console.log('N√£o foi poss√≠vel fechar a janela automaticamente');
          }
        }, 3000);
        
      } catch (globalError) {
        console.error('Erro no callback do Google:', globalError);
        document.body.innerHTML = `
          <h1 style="color: red;">‚ùå Erro Inesperado</h1>
          <p>Ocorreu um erro inesperado. Por favor, feche esta janela e tente novamente.</p>
        `;
      }
    })();
  </script>
</body>
</html>
