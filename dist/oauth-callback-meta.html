<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta http-equiv="Cross-Origin-Opener-Policy" content="same-origin-allow-popups" />
  <meta http-equiv="Cross-Origin-Embedder-Policy" content="unsafe-none" />
  <title>Meta OAuth Callback</title>
</head>
<body>
  <h1>Processando autentica√ß√£o Meta...</h1>
  <p>Aguarde enquanto processamos sua autentica√ß√£o.</p>

  <script>
    (function() {
      try {
        const params = new URLSearchParams(window.location.search);
        const accessToken = params.get('access_token');
        const error = params.get('error');
        const userDataStr = params.get('user_data');
        
        let userData = null;
        if (userDataStr) {
          try {
            userData = JSON.parse(userDataStr);
          } catch (e) {
            console.warn('Erro ao parsear dados do usu√°rio:', e);
          }
        }

        let result;
        if (accessToken) {
          // Sucesso
          result = {
            type: 'META_OAUTH_SUCCESS',
            accessToken,
            userInfo: userData?.userInfo || null,
            adAccounts: userData?.adAccounts || null,
            businessManagers: userData?.businessManagers || null,
            permissionErrors: userData?.permissionErrors || null,
            timestamp: Date.now()
          };
          
          // Preparar informa√ß√µes do usu√°rio para exibi√ß√£o
          const userInfo = userData?.userInfo;
          const adAccounts = userData?.adAccounts;
          const businessManagers = userData?.businessManagers;
          const permissionErrors = userData?.permissionErrors;
          
          let userDisplay = '';
          if (userInfo) {
            const profilePicture = userInfo.picture?.data?.url || userInfo.picture;
            userDisplay = `
              <div style="margin: 20px 0; padding: 15px; background: #f0f8ff; border-radius: 8px; border-left: 4px solid #1877f2;">
                <h3 style="margin: 0 0 10px 0; color: #1877f2;">Conta Meta Conectada:</h3>
                ${profilePicture ? `<img src="${profilePicture}" alt="Foto do perfil" style="width: 50px; height: 50px; border-radius: 50%; margin-right: 15px; vertical-align: middle;">` : ''}
                <div style="display: inline-block; vertical-align: middle;">
                  <p style="margin: 0; font-weight: bold; font-size: 16px;">${userInfo.name || 'Nome n√£o dispon√≠vel'}</p>
                  <p style="margin: 0; color: #666; font-size: 14px;">${userInfo.email || 'Email n√£o dispon√≠vel'}</p>
                  <p style="margin: 5px 0 0 0; color: #888; font-size: 12px;">ID: ${userInfo.id || 'N/A'}</p>
                </div>
              </div>
            `;
          }
          
          // Exibir contas de an√∫ncio
          let adAccountsDisplay = '';
          if (adAccounts && adAccounts.data && adAccounts.data.length > 0) {
            const accountCount = adAccounts.data.length;
            const accountsList = adAccounts.data.map(account => {
              const businessInfo = account.business_manager ? 
                `<div style="margin-top: 5px; padding: 4px 8px; background: #e3f2fd; border-radius: 3px; font-size: 11px;">
                  üè¢ <strong>BM:</strong> ${account.business_manager.name} (${account.business_manager.id})
                  <br>üìã <strong>Status:</strong> ${account.business_manager.verification_status}
                </div>` : 
                '<div style="margin-top: 5px; padding: 4px 8px; background: #fff3cd; border-radius: 3px; font-size: 11px;">‚ö†Ô∏è Sem Business Manager associado</div>';
              
              return `<li style="margin: 8px 0; padding: 10px; background: #f8f9fa; border-radius: 6px; border-left: 3px solid #28a745;">
                <strong>${account.name}</strong> (ID: ${account.id})<br>
                <small style="color: #666;">Status: ${account.account_status} | Moeda: ${account.currency}</small>
                ${businessInfo}
              </li>`;
            }).join('');
            
            adAccountsDisplay = `
              <div style="margin: 20px 0; padding: 15px; background: #d4edda; border-radius: 8px; border-left: 4px solid #28a745;">
                <h3 style="margin: 0 0 10px 0; color: #155724;">üìä Contas de An√∫ncio (${accountCount}):</h3>
                <ul style="margin: 10px 0; padding-left: 0; list-style: none;">${accountsList}</ul>
              </div>
            `;
          }
          
          // Exibir Business Managers
          let businessDisplay = '';
          if (businessManagers && businessManagers.data && businessManagers.data.length > 0) {
            const businessCount = businessManagers.data.length;
            const businessList = businessManagers.data.map(business => 
              `<li style="margin: 5px 0; padding: 8px; background: #f8f9fa; border-radius: 4px;">
                <strong>${business.name}</strong> (ID: ${business.id})<br>
                <small>Status: ${business.verification_status}</small>
              </li>`
            ).join('');
            
            businessDisplay = `
              <div style="margin: 20px 0; padding: 15px; background: #cce5ff; border-radius: 8px; border-left: 4px solid #007bff;">
                <h3 style="margin: 0 0 10px 0; color: #004085;">üè¢ Business Managers (${businessCount}):</h3>
                <ul style="margin: 10px 0; padding-left: 0; list-style: none;">${businessList}</ul>
              </div>
            `;
          }
          
          // Exibir erros de permiss√£o
          let permissionDisplay = '';
          if (permissionErrors && permissionErrors.length > 0) {
            const errorsList = permissionErrors.map(error => 
              `<li style="margin: 10px 0; padding: 10px; background: #f8d7da; border-radius: 4px; border-left: 3px solid #dc3545;">
                <strong>${error.type === 'ad_accounts' ? 'Contas de An√∫ncio' : 'Business Managers'}:</strong><br>
                <span style="color: #721c24;">${error.message}</span><br>
                <small style="color: #6c757d;">Permiss√µes necess√°rias: ${error.required_permissions.join(', ')}</small>
              </li>`
            ).join('');
            
            permissionDisplay = `
              <div style="margin: 20px 0; padding: 15px; background: #f8d7da; border-radius: 8px; border-left: 4px solid #dc3545;">
                <h3 style="margin: 0 0 10px 0; color: #721c24;">‚ö†Ô∏è Problemas de Permiss√£o:</h3>
                <ul style="margin: 10px 0; padding-left: 0; list-style: none;">${errorsList}</ul>
                <p style="margin: 10px 0 0 0; color: #6c757d; font-size: 12px;">Para resolver esses problemas, solicite as permiss√µes necess√°rias ao administrador da conta Meta.</p>
              </div>
            `;
          }
          
          // Atualiza a UI
          document.body.innerHTML = `
            <h1 style="color: green;">‚úÖ Autentica√ß√£o Meta Conclu√≠da!</h1>
            <p>Token obtido com sucesso!</p>
            ${userDisplay}
            ${adAccountsDisplay}
            ${businessDisplay}
            ${permissionDisplay}
            <p style="margin-top: 20px; color: #666;">Esta janela ser√° fechada automaticamente em alguns segundos.</p>
          `;
          
          // Notifica a janela principal com try/catch
          try {
            if (window.opener && !window.opener.closed) {
              window.opener.postMessage({
                type: 'meta_auth_success',
                data: result
              }, '*');
            }
          } catch (e) {
            console.log('Erro ao comunicar com janela principal:', e);
          }
        } else {
          // Erro
          const message = error || 'Access token not found in URL';
          result = {
            type: 'META_OAUTH_ERROR',
            message
          };
          
          // Atualiza a UI
          document.body.innerHTML = `
            <h1 style="color: red;">‚ùå Erro na Autentica√ß√£o Meta</h1>
            <p><strong>Motivo:</strong> ${message}</p>
            <p>Esta janela ser√° fechada automaticamente.</p>
          `;
          
          // Notifica a janela principal com try/catch
          try {
            if (window.opener && !window.opener.closed) {
              window.opener.postMessage({
                type: 'meta_auth_error',
                data: result
              }, '*');
            }
          } catch (e) {
            console.log('Erro ao comunicar com janela principal:', e);
          }
        }

        // Salva o resultado para o front ler
        localStorage.setItem('meta_oauth_result', JSON.stringify(result));
        // Manter compatibilidade com c√≥digo existente
        if (accessToken) {
          localStorage.setItem('META_ACCESS_TOKEN', accessToken);
        }

        // Fecha a janela ap√≥s 3 segundos
        setTimeout(() => {
          try {
            window.close();
          } catch (e) {
            console.log('N√£o foi poss√≠vel fechar a janela automaticamente');
          }
        }, 3000);
        
      } catch (globalError) {
        console.error('Erro no callback da Meta:', globalError);
        document.body.innerHTML = `
          <h1 style="color: red;">‚ùå Erro Inesperado</h1>
          <p>Ocorreu um erro inesperado. Por favor, feche esta janela e tente novamente.</p>
        `;
      }
    })();
  </script>
</body>
</html>